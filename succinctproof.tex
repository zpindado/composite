\subsection{Intuition}

Let $C_H$ be an arithmetic representation of either a hash function $H$ or a combination of several hash functions stitched properly. $C_H$ admits tuples $\{0,1\}^{n_0}$ as input elements. 
Given $z \in \Z_p$, we present a proof of knowledge of a value $x\in \Z_p$ such that $H(g^x)=z$ in the following.

We want to prove these three statements together in a single and succinct proof:
\begin{enumerate}
	\item Knowledge of $x \in \Z_p$ such that $y=x \mathcal{G}\in \G$ where $\mathcal{G}$ is the generator of $\G$. 
	\item Knowledge of $[\overline{y}] \in \G$ such that $H(\overline{y})=z$. 
	\item Finally, that $y=\overline{y}$.
\end{enumerate}
We have to prove all three conditions above by not leaking $[y]$, netiher $[\overline{y}]$!! The main ideas to prove them are explained in the following:
\begin{enumerate}
	\item We can prove knowledge of $x$ by producing a tuple ($[y], [\psi], [y_0]$) such that $e([y],[\psi])=e([y_0],[1])$, i.e. $[y_0]=[y \psi]$, for some given $[\psi] \in \G$ in the CRS. Applying KEA to this tuple we will have knowledge of $x$. The verification equation could be proven by a Groth-Sahai proof.
	\item SNARK of Groth is composed by 3 elements \cite{EC:Groth16}:
	\[\begin{split}
	[A]_1 = &\left[\alpha + \sum_{i=0}^m \overline{a}_i v_i(s) + r_1 \delta\right]_1  \hspace{40pt} [B]_2 = \left[\beta + \sum_{i=0}^m \overline{a}_i w_i(s) + r_2 \delta\right]_2\\
	[C]_1 = &\left[\frac{\sum_{i=n_0+1}^m \overline{a}_i\left(\beta v_i(s)+\alpha w_i(s)+y_i(s)+h(s)t(s)\right)+h(s)t(s)}{\delta}+Ar_2+B r_1+ r_1r_2\delta \right]_1
	\end{split}\]
	where $\{v_i(X),w_i(X),y_i(X)\}$ are the polynomials of the QAP, $s\in \Z_p$ is the secret point used to evaluate the polynomials in the CRS.
	We will use the same idea but we will split the element $A$ into two different commitments: $[A_0]$ containing just the secret input elements of the assignment $(\overline{a}_0,\dots,\overline{a}_{n_0})$, which will correspond with $\overline{y}$, and $[A_1]$ is the commitment of the evaluation of the input on $C_H$ $(\overline{a}_{n_0+1},\dots,\overline{a}_m)$.
	\item We can prove that $\overline{y}=y$ by a membership proof that gives us the vector
	$$\left[\begin{array}{c}
	A_0\\
	c\\
	\end{array}\right] \in \text{Im}\left[\begin{array}{c c c c c c}
	v_0(s) & \dots & v_{n_0}(s) & \delta & 0 & 0 \\
	2^0\vec{e}_2 & \dots & 2^{n_0} \vec{e}_2 & 0 & \vec{u}_1 & \vec{u}_2\\
	\end{array}\right],$$
	where $[c]$ is a Groth-Sahai commitment of the representation of $y \in \G$ in the perfectly binding setting and $[A_0]$ is the commitment from SNARK with the representation of $\overline{y}$. This proofs give us both commitments open to same representation, i.e. $\vec{a} = \overline{\vec{a}}$, \color{red}so $y=\overline{y}$\color{black}.
\end{enumerate}


\subsection{Proof}


$\gk  := (p,\G_1,\G_2,\G_T,\mathcal{G}_1,\mathcal{G}_2,e)$, where $DH$, $KEA$,... hold.

\paragraph{Setup.} \begin{itemize}
	\item Algorithm $\algK_0(\gk)$: For Groth-Sahai proof sample $\vec{u}_1,\vec{v} \gets \Z_p^2$, $\phi\gets \Z_p$ uniformly at random and compute a vector $\vec{u}_2\in \Z_p^2$ linear independent to $\vec{u}_2$.\\
	For SNARK proof compute QAP of the circuit $C_H$: $\left(\{v_i(X), w_i(X), y_i(X)\}_{i=1}^m, t(X)\right)$ of degree $n$. Sample $s \gets \Z_p$ uniformly at random to compute evaluation of QAP polynomials at point $s$ in $\G_1, \G_2$. Sample also $\alpha, \beta, \gamma, \delta \in \Z_p$ uniformaly at random.\\
	For membership proof sample $\mathbf{A} \gets \mathcal{D}_2$,
	$\mathbf{\Delta}\gets \Z_p^{2\times 2}$. Compute $[\mathbf{A}_{\mathbf{\Delta}}]_2=[\mathbf{\Delta}^{\top}\mathbf{A}]_2 \in \G_2^{2\times 2}$, $[\mathbf{M}_{\mathbf{\Delta}}]_1=[\mathbf{\Delta}\mathbf{M}]_1 \in \G_1^{2\times (n_0+3)}$, 
	where 
	$\mathbf{M}=\left(\begin{array}{c c c c c c}
	v_1(s) & \dots & v_k(s) & \delta & 0 & 0 \\
	2^0\vec{e}_2 & \dots & 2^k \vec{e}_2 & 0 & \vec{u}_1 &\vec{u}_2\\
	\end{array}\right) \in \Z_p^{2\times (n_0+3)}.$\\
	The CRS includes the elements 	
	\[\begin{split}
	&\left(\gk,[\vec{u}_1]_1,[\vec{u}_2]_1,[\vec{v}]_2,[\phi]_{1,2},[\alpha]_{1},[\beta]_{1,2},[\delta]_{1,2},[\gamma]_2,[\mathbf{M}_{\mathbf{\Delta}}]_1,[\mathbf{A}_{\mathbf{\Delta}}]_2,\left\{\left[s^{i}\right]_{1,2}\right\}_{i\in\{1,\dots,n-1\}},\right.\\
	&\left.
	\left\{\left[\frac{s^i t(s)}{\delta}\right]_1\right\}_{i=0}^{n-2},\left\{\left[\frac{\beta v_i(s)+\alpha w_i(s) +y_i(s)}{\gamma}\right]_1\right\}_{i=0}^{n_0},\left\{\left[\frac{\beta v_i(s)+\alpha w_i(s) +y_i(s)}{\delta}\right]_2\right\}_{i=n_0+1}^{m}\right)
	\end{split}\]
	
	The trapdoor: $\tau = (\vec{u}_1,\vec{u}_2,\vec{v}, \alpha, \beta,\gamma,\delta, s, \mathbf{\Delta})$.
\end{itemize} 


\noindent \textit{Prover}. 
\begin{itemize}
	\item The prover $\algP$ with input $(\textnormal{CRS},x)$ defines $[y]=x\mathcal{G}_1 \in \G_1$ and computes the following binary representation of $y= (P_x, P_y) \in \mathbb{F}_p$:
	$(a_{0},\dots,a_{n_0}) \in \{0,1\}^{n_0+1}$, where $\sum_{i=0}^{n_0} a_i 2^i=P_x\in \mathbb{F}_p$ and $a_{n_0} = sign(P_y)$.\\
	Evaluate $(a_{0},\dots,a_{n_0})$ in the circuit $C_H((a_{0},\dots,a_{n_0}))$ to obtain the whole assignment $\vec{a}\in \{0,1\}^m$ (this includes input of the circuit, middle gates, output of the circuit). Compute a SNARK proof $\pi_{\textsf{SNARK}}:=([A_0]_1,[A_1]_1,[B]_2,[C]_1)$ for circuit satisfiability of $C_H$ with input $(a_0,\dots,a_{n_0})$ such that $C_H((a_0,\dots,a_{n_0}))=z$, where
	\[\begin{split}
	[A]_0 = &\left[\sum_{i=0}^k a_i v_i(s) + r_1 \delta\right]_1  \hspace{40pt} [A]_1=\left[\alpha + \sum_{i=k+1}^m a_i v_i(s) + r_2 \delta\right]_1\\
	[B]_2 = &\left[\beta + \sum_{i=0}^m a_i w_i(s) + r_3 \delta\right]_2\\
	[C]_1 = &\left[\frac{\sum_{i=n_0+1}^m a_i\left(\beta v_i(s)+\alpha w_i(s)+y_i(s)+h(s)t(s)\right)+h(s)t(s)}{\delta}+Ar_3\right.\\
	&\left.+B (r_1+r_2)+ (r_1+r_2)r_3\delta\right]_1,
	\end{split}\]
	for some $r_1,r_2,r_3 \gets \Z_p$ chosen uniformly at random.\\
	Compute $[y_0]_1=x[\phi]_1\in\G_1$ and a Groth-Sahai proof for the pairing equation
	\begin{equation}\label{GS1}
	e([y]_1,[\phi]_2)=e([y_0]_1,[1]_2),
	\end{equation}
	$\pi_{\textsf{G-S}}:=([\theta_1]_1,[\theta_2]_1)$ such that
	\begin{equation}\label{GS2}
	F([c]_1,[\phi]_2\vec{e}_1)+F([\theta_1]_1,[\vec{v}]_2) = F([c_2]_1,[\vec{v}]_2)+F([\theta_2]_1,[\phi]_2\vec{e}_1)
	\end{equation}
	where $[c]_1=\sum a_i 2^i [\vec{e}_2]_1+r_4[\vec{u}_1]_1 + r_5[\vec{u}_2]_1$, $[c_2]_1 = [y_0]_1\vec{e}_2 + s_1[\vec{u}_1]_1+s_2[\vec{u}_2]_1$ for some $r_4,r_5,s_1,s_2\gets \Z_p$ chosen uniformly at random.\\
	The prover also computes a membership proof $\psi=[\mathbf{M}_{\mathbf{\Delta}}]_1(\vec{a},r_1,r_4,r_5)^{\top}\in \G_1^{2}$ of 
	$$\left[\begin{array}{c}
	A_0\\
	c\\
	\end{array}\right]_1 \in \text{Im}\left(\left[\mathbf{M}\right]_1\right).$$	
	Finally, it sends the proof $\pi:= \left(\pi_{\textsf{SNARK}}, \pi_{\textsf{G-S}},[c]_1,[c_2]_1,\psi\right)$ to the verifier.
\end{itemize}

\noindent \textit{Verifier}. 

The verifier $\algV$ with input $(\textnormal{CRS},\pi)$ verify the proofs $\pi_{\textsf{SNARK}}$, $\pi_{\textsf{G-S}}$, $\psi$.

\subsubsection*{Soundness}
%Assume that there is an advesary $\mathcal{A}$ that breaks soundness, i.e. it sends a proof $\pi$ such that \textit{Verifier}$(\pi)=1$ but at least one of these events occurs:
%\begin{enumerate}
%	\item $E_1$: $\neg $ (Knowledge of $x \in \Z_p$ such that $x\mathcal{G}_1 = [y]_1$).
%	\item $E_2$: $H(\overline{y}) \neq z$
%	\item $E_3$: $\overline{y} \neq y$
%\end{enumerate}

If the verifier has accepted the membership proof, for soundness of $\psi$, there exists some $\vec{w} \in \Z_p^3$ such that
$$\left[\begin{array}{c}
A\\
\vec{c}_y\\
\end{array}\right]_1 = \left[\mathbf{M}\right]_1 \vec{w}.$$

$A$ is a perfectly hiding commitment, so many $\vec{\hat{w}}$ may produce same 
$$A=\left[\overline{\mathbf{M}}\right]_1\vec{\hat{w}}=\left[\overline{\mathbf{M}}\right]_1\vec{w},$$
 but $\vec{c}_y$ is a perfectly binding commitment because is a G-S commitment in the soundness setting and moreover $\vec{c}_y$ is extractable. Thus, $[y]_1 \in \G_1$ is the unique possible opening to $[\vec{c}_y]_1$, which fixes the first $n_0$ components of $\vec{a}$ in $A$ (because $y$ is represented uniquely as $y=\sum a_i 2^i$).

For soundness of the SNARK proof is accepted, we have a proof of knowledge of some pre-image $\overline{y}$ of $H$ such that $H(\overline{y})=z$, which can be represented as $\overline{y} = \sum \overline{a}_i 2^i$.

For the G-S proof, we have a tuple $([y]_1,[\phi]_{1,2},[y_0]_1)$ such that $e([y]_1, [\phi]_2) =e([y_0]_1,[1]_2)$, so the prover has to know $x \in \Z_p$ such that $[y]_1 = x \mathcal{G}$ for KEA assumption.

%Assume the event $E_3$ occurs for $\overline{y}, y \in \G_1$ that could be represented uniquely as
%\[y=\sum_{i=0}^{n_0} a_i 2^i, \quad\quad \overline{y}=\sum_{i=0}^{n_0} \overline{a}_i 2^i,\]
%for at least one $i$ $a_i \neq \overline{a}_i$ but membership proof is accepted. Thus, we have
%$$ \left[\mathbf{M}\right]_1 (\vec{a},r_1,r_4,r_5) = \left[\mathbf{M}\right]_1 (\vec{\overline{a}},s_1,s_4,s_5), $$
%where second row of the result of both sizes is the commitment $[c]_1$. If it was true, then perfectly binding property of G-S commitments would be broken due to we are in the soundness setting of G-S.
%
%If the event $E_2 \cap \overline{E_3}$ occurs, for some $\overline{y} \in \G_1$ that we can represent as $\overline{y}=\sum_{i=0}^{n_0} a_i$ (because we are in $\overline{E_3}$) such that proof is accepted but $H(\vec{a}) \neq z$ it means soundness of Groth 16 SNARK is broken.
%
%If the event $E_1$ occurs, it means that equation (\ref{GS2}) holds but (\ref{GS1}) does not hold. It could happen because either Groth-Sahai soundness is broken or the commitments $[c]_1, [c_2]_1$ are not computed correctly. If $[c]_1$ were not computed correctly, then $E_3$ would occur and we had analysed this scenario above. If $[c_2]_1$ were not computed correctly but $[c]_1$ does, then we would had
%$$e([y]_1,[\psi]_2)=e([?]_1,[1]_2),$$
%so $[?]_T=[y \psi]_T$ in anyhow, so KEA is broken.

\subsubsection*{Zero-Knowledge}

The simulator $\algS$ with input CRS, $\tau = (\vec{u}_1,\vec{u}_2,\vec{v}, \alpha, \beta,\gamma,\delta, s, \mathbf{\Delta})$, is a compound simulator of the respective proofs SNARK \cite{EC:Groth16}, Membership proof in linear spaces \cite{AC:GonHevRaf15} and Groth-Sahai proof \cite{EC:GroSah08}.